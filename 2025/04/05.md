# ğŸ“š 2025.04.05 TIL 
## ìë°” ORM í‘œì¤€ JPA í”„ë¡œê·¸ë˜ë° (ê¹€ì˜í•œ)
##  â—† í”„ë¡ì‹œì™€ ì—°ê´€ê´€ê³„ ê´€ë¦¬
JPA ì—ì„œ í”„ë¡ì‹œ ê°ì²´ëŠ” ì§€ì—° ë¡œë”©ì„ êµ¬í˜„í•˜ê¸° ìœ„í•œ í•µì‹¬ ë©”ì»¤ë‹ˆì¦˜ì´ë‹¤. 
### 1. í”„ë¡ì‹œ ê°ì²´ë€?
- í”„ë¡ì‹œ ê°ì²´ëŠ” ì‹¤ì œ ì—”í‹°í‹° ê°ì²´ë¥¼ ëŒ€ì‹ í•˜ëŠ” ê°€ì§œ ê°ì²´ì´ë‹¤.
- JPAëŠ” ì—”í‹°í‹°ë¥¼ ì‹¤ì œë¡œ DBì—ì„œ ì¡°íšŒí•˜ì§€ ì•Šê³ ë„ ì¼ë‹¨ í”„ë¡ì‹œ ê°ì²´ë¥¼ ìƒì„±í•´ì„œ
ë°˜í™˜í•  ìˆ˜ ìˆê³  ì´ í”„ë¡ì‹œ ê°ì²´ëŠ” í•„ìš”í•œ ì‹œì ì— ì‹¤ì œ ë°ì´í„°ë¥¼ DBì—ì„œ ì¡°íšŒí•œë‹¤.

### âœ¨ ì˜ˆì‹œ ì½”ë“œ: 
```java
@Entity
public class Order {
    @Id
    private Long id;

    @ManyToOne(fetch = FetchType.LAZY)
    private Member member;
}
```
### ë‚´ë¶€ ë™ì‘:
1. order.getMember()ë¥¼ í˜¸ì¶œí•œë‹¤.
2. JPAëŠ” Hibernate í”„ë¡ì‹œ ê°ì²´ë¥¼ Member ëŒ€ì‹  ìƒì„±í•´ ë†“ëŠ”ë‹¤.
(Member$HibernateProxy ê°™ì€ í´ë˜ìŠ¤)
3. í”„ë¡ì‹œ ê°ì²´ëŠ” ë‚´ë¶€ì ìœ¼ë¡œ ì‹¤ì œ Memberì˜ IDë¥¼ ê°€ì§€ê³  ìˆìŒ.
4. member.getName()ì²˜ëŸ¼ í•„ë“œë¥¼ ì ‘ê·¼í•˜ë ¤ëŠ” ìˆœê°„, ê·¸ì œì„œì•¼ DBë¥¼ 
ì¡°íšŒí•´ì„œ ì§„ì§œ Member ê°ì²´ë¥¼ ì±„ì›Œ ë„£ëŠ”ë‹¤(ì´ˆê¸°í™”).

### âœ¨ ê°„ë‹¨í•œ í”„ë¡ì‹œ ì˜ˆì œ:
```java
Order order = em.find(Order.class, 1L); // order ì¡°íšŒ
Member memberProxy = order.getMember(); // í”„ë¡ì‹œ ê°ì²´ ë°˜í™˜ (ì•„ì§ SELECT ì•ˆí•¨)

System.out.println("class: " + memberProxy.getClass()); 
// com.example.Member$HibernateProxy

System.out.println("name: " + memberProxy.getName()); 
// ì´ ì‹œì ì— SELECT ì¿¼ë¦¬ ë°œìƒ

System.out.println("email: " + memberProxy.getEmail()); 
// SELECT ì—†ìŒ, ì´ë¯¸ ì´ˆê¸°í™”ë¨
// í”„ë¡ì‹œ ê°ì²´ëŠ” í•œ ë²ˆ ì´ˆê¸°í™”ë˜ë©´ ê·¸ ì´í›„ì—ëŠ” ë‹¤ì‹œ DBë¥¼ ì¡°íšŒí•˜ì§€ ì•ŠìŒ.
```

### 2. í”„ë¡ì‹œì˜ íŠ¹ì§•
- í”„ë¡ì‹œ ê°ì²´ë¥¼ ì´ˆê¸°í™” í•  ë•Œ, í”„ë¡ì‹œ ê°ì²´ê°€ ì‹¤ì œ ì—”í‹°í‹°ë¡œ ë°”ë€ŒëŠ” ê²ƒì€ ì•„ë‹˜,
ì´ˆê¸°í™” ë˜ë©´ í”„ë¡ì‹œ ê°ì²´ë¥¼ í†µí•´ì„œ ì‹¤ì œ ì—”í‹°í‹°ì— ì ‘ê·¼ ê°€ëŠ¥
- í”„ë¡ì‹œ ê°ì²´ëŠ” ì›ë³¸ ì—”í‹°í‹°ë¥¼ ìƒì†ë°›ìŒ, ë”°ë¼ì„œ íƒ€ì… ì²´í¬ì‹œ ì£¼ì˜í•´ì•¼í•¨
  (== ë¹„êµì‹œ ì‹¤íŒ¨, ëŒ€ì‹  instance of ì‚¬ìš©)
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ì°¾ëŠ” ì—”í‹°í‹°ê°€ ì´ë¯¸ ìˆìœ¼ë©´ em.getReference()ë¥¼
í˜¸ì¶œí•´ë„ ì‹¤ì œ ì—”í‹°í‹°ë¥¼ ë°˜í™˜
- ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì˜ ë„ì›€ì„ ë°›ì„ ìˆ˜ ì—†ëŠ” ì¤€ì˜ì† ìƒíƒœì¼ ë•Œ, í”„ë¡ì‹œë¥¼ ì´ˆê¸°í™”í•˜ë©´
ë¬¸ì œ ë°œìƒ (í•˜ì´ë²„ ë„¤ì´íŠ¸ëŠ” org.hibernate.LazyInitializationException)
ì˜ˆì™¸ë¥¼ í„°ëœ¨ë¦¼

### 3. getReference() í˜¸ì¶œ ì‹œ ë¬´ìŠ¨ ì¼ì´ ë²Œì–´ì§€ë‚˜?
```java
Member proxy = em.getReference(Member.class, 1L);
```
1. ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸(1ì°¨ ìºì‹œ)ë¥¼ ë¨¼ì € í™•ì¸
- Member ì—”í‹°í‹°ì˜ IDê°€ ì´ë¯¸ ìºì‹œì— ì¡´ì¬í•˜ë©´ ì‹¤ì œ ì—”í‹°í‹°ë¥¼ ë°˜í™˜ (find()ì™€ ë™ì¼í•œ ë™ì‘).
2. ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´
- HibernateëŠ” í•´ë‹¹ IDì— ëŒ€í•œ í”„ë¡ì‹œ ê°ì²´ë¥¼ ìƒì„±
- ì´ í”„ë¡ì‹œ ê°ì²´ë¥¼ ì˜ì†ì„± ì»¨í…ìŠ¤íŠ¸ì— ë“±ë¡
3. ì´í›„ ë™ì¼í•œ ì—”í‹°í‹° IDë¡œ find()ë¥¼ í˜¸ì¶œí•˜ë“ , getReference()ë¥¼ í˜¸ì¶œí•˜ë“ 
í•­ìƒ ê°™ì€ ì¸ìŠ¤í„´ìŠ¤(1ì°¨ ìºì‹œ)ë¥¼ ë°˜í™˜í•œë‹¤. </br></br>

## â—† ì˜ì†ì„± ì „ì´: CASCADE
íŠ¹ì • ì—”í‹°í‹°ë¥¼ ì˜ì† ìƒíƒœë¡œ ë§Œë“¤ ë•Œ ì—°ê´€ëœ ì—”í‹°í‹°ë„ í•¨ê»˜ ì˜ì†ìƒíƒœë¡œ ë§Œë“¤ê³ 
ì‹¶ì„ ë•Œ ì‚¬ìš©. ì—”í‹°í‹° ìƒíƒœ ë³€ê²½ì„ ì—°ê´€ëœ ì—”í‹°í‹°ê¹Œì§€ ì „íŒŒí•´ì£¼ëŠ” ì˜µì…˜ì´ë‹¤.

### âœ¨ ì‚¬ìš© ì˜ˆì‹œ:
```java
@Entity
public class Parent {
  @Id @GeneratedValue
  private Long id;

  private String name;

  @OneToMany(mappedBy = "parent", cascade = CascadeType.ALL, orphanRemoval = true)
  private List<Child> children = new ArrayList<>();

  public void addChild(Child child) {
    children.add(child);
    child.setParent(this);
  }
}

@Entity
public class Child {
  @Id @GeneratedValue
  private Long id;

  private String name;

  @ManyToOne
  private Parent parent;
}
```
```java
Parent parent = new Parent();
parent.setName("ì—„ë§ˆ");

Child child1 = new Child();
child1.setName("ìì‹1");

Child child2 = new Child();
child2.setName("ìì‹2");

parent.addChild(child1);
parent.addChild(child2);

em.persist(parent); // ë¶€ëª¨ë§Œ ì €ì¥í•˜ë©´, ìì‹ë“¤ë„ ìë™ ì €ì¥ë¨!
```
### ìœ„ ì˜ˆì œ ì½”ë“œì—ì„œ CascadeType.ALLì„ ì‚¬ìš©í•œ ë•ë¶„ì—:
- em.persist(child1) / em.persist(child2)ë¥¼ í•˜ì§€ ì•Šì•„ë„ë¨.
- ì‚­ì œ ì‹œì—ë„ em.remove(parent)ë§Œ í•˜ë©´ ìì‹ë„ ê°™ì´ ì‚­ì œë¨. </br></br>

## â—† ê³ ì•„ ê°ì²´ ì‚­ì œ
orphanRemoval = true ì„¤ì • ì‹œ ë¶€ëª¨ ì—”í‹°í‹°ì™€ì˜ ì—°ê´€ê´€ê³„ê°€ ëŠê¸´
ìì‹ ì—”í‹°í‹°(ê³ ì•„ ê°ì²´)ë¥¼ ìë™ìœ¼ë¡œ ì‚­ì œí•´ì¤€ë‹¤. ì—°ê´€ ì»¬ë ‰ì…˜ì—ì„œ ìì‹ì„
ì œê±°í•˜ê±°ë‚˜ ê´€ê³„ë¥¼ ëŠìœ¼ë©´ DBì—ì„œë„ DELETE ì¿¼ë¦¬ê°€ ìë™ ë°œìƒí•œë‹¤.

### âœ¨ ì‚¬ìš© ì˜ˆì‹œ:
```java
@Entity
public class Parent {
    @Id @GeneratedValue
    private Long id;

    @OneToMany(mappedBy = "parent", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Child> children = new ArrayList<>();

    public void addChild(Child child) {
        children.add(child);
        child.setParent(this);
    }

    public void removeChild(Child child) {
        children.remove(child);
        child.setParent(null);
    }
}

@Entity
public class Child {
    @Id @GeneratedValue
    private Long id;

    @ManyToOne
    private Parent parent;
}
```
```java
Parent parent = em.find(Parent.class, 1L);
Child child = parent.getChildren().get(0);

parent.removeChild(child);  // ê´€ê³„ ëŠê¸°
// íŠ¸ëœì­ì…˜ ì»¤ë°‹ ì‹œ -> ìë™ìœ¼ë¡œ DELETE FROM child where id=?
```
```orphanRemoval = true``` ì—†ìœ¼ë©´: ìì‹ì€ ì—°ê´€ë§Œ ëŠê¸°ê³  DBì—ëŠ” ê·¸ëŒ€ë¡œ ë‚¨ìŒ. </br>
```orphanRemoval = true``` ìˆìœ¼ë©´: ì—°ê´€ ëŠê¸°ë©´ ìì‹ë„ ìë™ ì‚­ì œë¨.









